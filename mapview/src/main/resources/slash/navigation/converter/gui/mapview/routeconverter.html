<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>RouteConverter MapView</title>
    <script src="http://${mapserver}/maps/api/js?v=3.7&amp;sensor=false&amp;libraries=geometry&amp;language=${language}&amp;region=${country}" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" type="text/javascript"></script>
    <script src="./contextmenu.js" type="text/javascript"></script>
    <script src="./keydragzoom.js" type="text/javascript"></script>
    <style type="text/css">
        html { overflow: hidden }
        body { margin: 0; padding: 0 }
        .normal { position: absolute; top: 0; left: 0; bottom: 0; right: 0; width: 100%; height: 100% }
        #map { width: 100%; height: 100% }
        #directions { display: none; padding-top: 20px }

        .ContextMenu {
            position: absolute;
            z-index: 1000;
            display: none;
            background: #f0f0f0;
            border: 1px solid #a0a0a0;
            min-width: 90px;
        }
        .ContextMenu ul {
            padding: 1px 0 1px 0;
            margin: 0;
        }
        .ContextMenu li {
            list-style: none;
            padding: 0 1px;
            margin: 0;
        }
        .ContextMenu a {
            display: block;
            color: #000000;
            font-family: Verdana, Arial, sans-serif;
            font-size: 10px;
            text-decoration: none;
            line-height: 22px;
            padding: 1px 8px;
            border: 1px solid #f0f0f0;
        }
        .ContextMenu li.hover a {
            background-color: #ecf1f6;
            border: 1px solid #aecff7;
        }
        .ContextMenu li.separator div {
            border-top: solid 1px #cccccc;
        }
    </style>
</head>
<body class="normal" onload="initialize();"
      ondragstart="return false;" onselectstart="return false;"
      ondragenter="return false;" ondragover="return false;"
      ondrop="return false;" oncontextmenu="return false;">
<div id="error"></div>
<div id="map"></div>
<div id="directions"></div>
<script type="text/javascript">
   function printMap(title, withDirections) {
       try {
           document.head.title = "";
       }
       catch (e) {
           addDebug("Cannot set head.title " + e);
       }
       try {
           var oldTitle = document.title;
           document.title = title;
           adjustForPrinting(true, withDirections);

           window.print();

           adjustForPrinting(false, withDirections);
           document.title = oldTitle;
       }
       catch (e) {
           setError("<p>Sorry, could not print map.</p><p>Error name: " + e.name + "</p><p>Error message: " + e.message + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
       }
   }

   function adjustForPrinting(show, withDirections) {
       if (withDirections) {
           var div = document.getElementById("directions");
           div.style.display = show ? "block" : "none";
           for (i = 0; i < div.childNodes.length; i++) {
               div.childNodes[i].style.display = show ? "block" : "none";
           }
       }
       document.body.className = show ? "" : "normal";
   }

   function resize(width, height) {
       var div = document.getElementById("map");
       div.style.width = width + "px";
       div.style.height = height + "px";
   }

   function panTo(latitude, longitude) {
       var latLng = new google.maps.LatLng(latitude, longitude);
       if (!map.getBounds().contains(latLng))
           map.panTo(latLng);
   }

   function setCenter(latitude, longitude) {
       map.setCenter(new google.maps.LatLng(latitude, longitude));
   }

   function setZoom(zoom) {
       map.setZoom(zoom);
   }

   function fitBounds(southWestLatitude, southWestLongitude, northEastLatitude, northEastLongitude) {
       map.fitBounds(new google.maps.LatLngBounds(new google.maps.LatLng(southWestLatitude, southWestLongitude),
               new google.maps.LatLng(northEastLatitude, northEastLongitude)));
   }

   var callbackQueue = [];

   function getCallbacks() {
       var callbacks = callbackQueue.join("--");
       callbackQueue = [];
       return callbacks;
   }

   var callbackCount = 0;

   function callJava(uri) {
       if (xmlhttp && callbackListenerPort > 0) {
           callbackCount++;
           xmlhttp.open("GET", "http://127.0.0.1:" + callbackListenerPort + "/" + callbackCount + "/" + uri, true);
           xmlhttp.send();
       } else {
           callbackQueue.push(uri);
       }
   }

   function callJavaWithPost(body) {
       if (xmlhttp && callbackListenerPort > 0) {
           callbackCount++;
           xmlhttp.open("POST", "http://127.0.0.1:" + callbackListenerPort + "/" + callbackCount + "/generic-post-url/", true);
           xmlhttp.send(body);
       } else {
           callbackQueue.push(body);
       }
   }

   var callbackListenerPort = -1;

   function setCallbackListenerPort(callbackListenerPort) {
       this.callbackListenerPort = callbackListenerPort;
   }

   function checkCallbackListenerPort() {
       callJava("callback-port/" + callbackListenerPort);
   }

   function addListener(marker) {
       google.maps.event.addListener(marker, "dragend", function() {
           var position = marker.getPosition();
           var index = marker.index_;
           callJava("move-position/" + index + "/" + position.lat() + "/" + position.lng());
       });
   }

   var oldSelectedPositions = new Array();
   var newSelectedPositions = new Array();

   function selectionPosition(latitude, longitude, comment, index) {
       var marker = new google.maps.Marker({position:new google.maps.LatLng(latitude, longitude),
           title:comment, draggable:true, zIndex:1000});
       marker.index_ = index;
       addListener(marker);
       newSelectedPositions.push(marker);
       marker.setMap(map);
   }

   function removeSelectedPositions() {
       while (oldSelectedPositions.length > 0) {
           oldSelectedPositions.pop().setMap(null);
       }
       oldSelectedPositions = newSelectedPositions;
       newSelectedPositions = new Array();
   }

   function addPolyline(latlngs, color, weight) {
       addOverlay(new google.maps.Polyline({path:latlngs, strokeColor:color, strokeWeight:weight, strokeOpacity:1, clickable:false}));
   }

   var markerIcon;

   function addMarker(latitude, longitude, comment) {
       addOverlay(new google.maps.Marker({position:new google.maps.LatLng(latitude, longitude),
           title:comment, clickable:false, icon:markerIcon}));
   }

   function insertAllWaypoints(directionsRequest, index) {
       directionsService.route(directionsRequest, function(result, status) {
           if (status == google.maps.DirectionsStatus.OK) {
               for (var i = 0; i < result.routes.length; i++) {
                   var legs = result.routes[i].legs;
                   var waypoints = [];
                   for (var j = 0; j < legs.length; j++) {
                       var steps = legs[j].steps;
                       for (var k = 0; k < steps.length; k++) {
                           var path = steps[k].path;
                           for (var l = 0; l < path.length - 1; l++) {
                               waypoints.push(path[l].lat());
                               waypoints.push(path[l].lng());
                               waypoints.push(l == path.length - 2 ? steps[k].distance.value : 0);
                               waypoints.push(l == path.length - 2 ? steps[k].duration.value : 0);
                               waypoints.push(l == 0 ? removeTags(steps[k].instructions) : "-");
                           }
                       }
                   }
                   callJavaWithPost("Insert-All-Waypoints: " + index + "/" + waypoints.join("/") + "\n\n");
               }
           } else {
               setError("<p>Sorry, could not insert all waypoints.</p><p>Status: " + status + "</p><p>Result: " + result + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
           }
       });
   }

   function removeTags(string) {
       string = string.replace(/&(lt|gt);/g, function (strMatch, p1) {
           return (p1 == "lt") ? "<" : ">";
       });
       string = string.replace(/<div[^>]*>/g, ", ");
       string = string.replace(/<[^>]+>/g, " ");
       string = string.replace(/ \( /g, " (");
       string = string.replace(/ \) /g, ") ");
       string = string.replace(/ , /g, ", ");
       string = string.replace(/\//g, " ");
       string = string.replace(/  /g, " ");
       string = string.replace(/^\s+|\s+$/g, "");
       return string;
   }

   function insertOnlyTurnpoints(directionsRequest, index) {
       directionsService.route(directionsRequest, function(result, status) {
           if (status == google.maps.DirectionsStatus.OK) {
               for (var i = 0; i < result.routes.length; i++) {
                   var legs = result.routes[i].legs;
                   var turnpoints = [];
                   for (var j = 0; j < legs.length; j++) {
                       var steps = legs[j].steps;
                       for (var k = 0; k < steps.length; k++) {
                           turnpoints.push(steps[k].end_location.lat());
                           turnpoints.push(steps[k].end_location.lng());
                           turnpoints.push(steps[k].distance.value);
                           turnpoints.push(steps[k].duration.value);
                           turnpoints.push(k < steps.length - 1 ? removeTags(steps[k + 1].instructions) : "-");
                       }
                   }
                   callJavaWithPost("Insert-Only-Turnpoints: " + index + "/" + turnpoints.join("/") + "\n\n");
               }
           } else {
               setError("<p>Sorry, could not insert only turnpoints.</p><p>Status: " + status + "</p><p>Result: " + result + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
           }
       });
   }

   function insertPosition(result, startIndex) {
       for (var i = 0; i < result.routes.length; i++) {
           var legs = result.routes[i].legs;
           for (var j = 0; j < legs.length; j++) {
               var via_waypoints = legs[j].via_waypoints;
               for (var k = 0; k < via_waypoints.length; k++) {
                   var latLng = via_waypoints[k];
                   callJava("insert-position/" + (startIndex + j) + "/" + latLng.lat() + "/" + latLng.lng());
               }
           }
       }
   }

   var meters = 0;
   var seconds = 0;

   function fireDirectionsLoaded() {
       callJava("directions-load/" + meters + "/" + seconds);
   }

   function resetDirections() {
       meters = 0;
       seconds = 0;
       fireDirectionsLoaded();
   }

   function renderDirections(directionsRequest, startIndex, lastSegment) {
       directionsService.route(directionsRequest, function(result, status) {
           if (status == google.maps.DirectionsStatus.OK) {
               var panel = document.createElement("div");
               var renderer = new google.maps.DirectionsRenderer({preserveViewport: true, suppressMarkers: true,
                   draggable: true, hideRouteList: true, directions: result, panel: panel});
               google.maps.event.addListener(renderer, "directions_changed", function() {
                   insertPosition(renderer.directions, startIndex);
               });
               addDirections(renderer, panel);

               for (var i = 0; i < result.routes.length; i++) {
                   var legs = result.routes[i].legs;
                   for (var j = 0; j < legs.length; j++) {
                       meters += legs[j].distance.value;
                       seconds += legs[j].duration.value;
                   }
               }
               fireDirectionsLoaded();

               if (lastSegment)
                   removeDirections();
           } else if (status == google.maps.DirectionsStatus.ZERO_RESULTS) {
               resetDirections();

               if (lastSegment)
                   removeDirections();
           } else {
               setError("<p>Sorry, could not render directions.</p><p>Status: " + status + "</p><p>Result: " + result + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
           }
       });
   }

   var oldRenderer = new Array();
   var newRenderer = new Array();
   var oldPanels = new Array();
   var newPanels = new Array();

   function addDirections(renderer, panel) {
       newRenderer.push(renderer);
       newPanels.push(panel);
   }

   function removeDirections() {
       for (i = 0; i < newRenderer.length; i++) {
           newRenderer[i].setMap(map);
       }
       while (oldRenderer.length > 0) {
           oldRenderer.pop().setMap(null);
       }
       oldRenderer = newRenderer;
       newRenderer = new Array();

       var div = document.getElementById("directions");
       for (i = 0; i < newPanels.length; i++) {
           div.appendChild(newPanels[i]);
       }
       while (oldPanels.length > 0) {
           div.removeChild(oldPanels.pop());
       }
       oldPanels = newPanels;
       newPanels = new Array();
   }

   var oldOverlays = new Array();
   var newOverlays = new Array();

   function addOverlay(overlay) {
       newOverlays.push(overlay);
   }

   function removeOverlays() {
       for (i = 0; i < newOverlays.length; i++) {
           newOverlays[i].setMap(map);
       }
       while (oldOverlays.length > 0) {
           oldOverlays.pop().setMap(null);
       }
       oldOverlays = newOverlays;
       newOverlays = new Array();
   }

   function getNorthEastBounds() {
       return map.getBounds().getNorthEast().toUrlValue(6);
   }

   function getSouthWestBounds() {
       return map.getBounds().getSouthWest().toUrlValue(6);
   }

   function getThresholdForPixel(map, latLng, pixel) {
       var worldCoordinate = map.getProjection().fromLatLngToPoint(latLng);
       var scale = Math.pow(2, map.getZoom());
       worldCoordinate.x = worldCoordinate.x + pixel / scale;
       var pixelAway = map.getProjection().fromPointToLatLng(worldCoordinate);
       return google.maps.geometry.spherical.computeDistanceBetween(latLng, pixelAway);
   }

   var debug = document.createElement("div");

   function addDebug(text) {
       var element = document.createElement("p");
       var node = document.createTextNode(text);
       element.appendChild(node);
       debug.appendChild(element);
   }

   function setError(text) {
       var element = document.createElement("div");
       element.innerHTML = text;
       var error = document.getElementById("error");
       error.style.padding = "20pt";
       error.appendChild(element);
       error.appendChild(debug);
   }

   function ignoreCtrlF(event) {
       if (event.ctrlKey && event.keyCode == 70) {
           event.preventDefault();
       }
   }

   var initialized, map, directionsService, xmlhttp;

   function isInitialized() {
       return initialized;
   }

   function initialize() {
       initialized = false;
       document.body.className = "normal";
       addDebug("1. initialize()");
       try {
           var mapnikMapType = new google.maps.ImageMapType({
               getTileUrl: function(coord, zoom) {
                   return "http://tile.openstreetmap.org/" + zoom + "/" + coord.x + "/" + coord.y + ".png";
               },
               tileSize: new google.maps.Size(256, 256),
               maxZoom: 18,
               alt: "Mapnik rendering of OpenStreetMap data",
               name: "Mapnik"
           });
           var cycleMapType = new google.maps.ImageMapType({
               getTileUrl: function(coord, zoom) {
                   return "http://tile.opencyclemap.org/cycle/" + zoom + "/" + coord.x + "/" + coord.y + ".png";
               },
               tileSize: new google.maps.Size(256, 256),
               maxZoom: 18,
               alt: "OpenCycleMap rendering of OpenStreetMap data",
               name: "Cycle"
           });
           var hikeMapType = new google.maps.ImageMapType({
               getTileUrl: function(coord, zoom) {
                   return "http://toolserver.org/tiles/hikebike/" + zoom + "/" + coord.x + "/" + coord.y + ".png";
               },
               tileSize: new google.maps.Size(256, 256),
               maxZoom: 18,
               alt: "HikeBikeMap rendering of OpenStreetMap data",
               name: "Hike"
           });
           var outdoorMapIndex = 0;
           var outdoorActiveSummerMapType = new google.maps.ImageMapType({
               getTileUrl: function(coord, zoom) {
                   outdoorMapIndex++;
                   if (outdoorMapIndex > 3)
                       outdoorMapIndex = 0;
                   return "http://s" + outdoorMapIndex + ".outdooractive.com/portal/map/" + zoom + "/" + coord.x + "/" + coord.y + ".png";
               },
               tileSize: new google.maps.Size(256, 256),
               minZoom: 8,
               maxZoom: 17,
               alt: "Outdoor Active Summer Map",
               name: "Outdoor"
           });
           var outdoorActiveTopoMapType = new google.maps.ImageMapType({
               getTileUrl: function(coord, zoom) {
                   outdoorMapIndex++;
                   if (outdoorMapIndex > 3)
                       outdoorMapIndex = 0;
                   var mapType = zoom > 15 ? "topo" : "map";
                   return "http://s" + outdoorMapIndex + ".outdooractive.com/portal/" + mapType + "/" + zoom + "/" + coord.x + "/" + coord.y + ".png";
               },
               tileSize: new google.maps.Size(256, 256),
               minZoom: 8,
               maxZoom: 17,
               alt: "Outdoor Active Topographic Map",
               name: "Topographic"
           });

           var mapOptions = {
               mapTypeId: google.maps.MapTypeId.ROADMAP,
               mapTypeControlOptions: {
                   mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE,
                       google.maps.MapTypeId.HYBRID, google.maps.MapTypeId.TERRAIN,
                       'Mapnik', 'T@H', 'Cycle', 'Hike', 'Outdoor', 'Topographic'],
                   style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
               },
               panControl: false,
               zoomControlOptions: {
                   style: google.maps.ZoomControlStyle.LARGE
               },
               disableDefaultUI: false,
               streetViewControl: false,
               scaleControl: true,
               draggableCursor: 'default',
               draggingCursor: 'pointer'
           };

           var copyrightControl = document.createElement('div');
           copyrightControl.id = 'copyright-control';
           copyrightControl.style.fontSize = '10px';
           copyrightControl.style.fontFamily = 'Arial, sans-serif';
           copyrightControl.style.margin = '0 2px 4px 0';
           copyrightControl.style.whitespace = 'nowrap';
           copyrightControl.index = 1;

           map = new google.maps.Map(document.getElementById("map"), mapOptions);
           map.mapTypes.set('Mapnik', mapnikMapType);
           map.mapTypes.set('Cycle', cycleMapType);
           map.mapTypes.set('Hike', hikeMapType);
           map.mapTypes.set('Outdoor', outdoorActiveSummerMapType);
           map.mapTypes.set('Topographic', outdoorActiveTopoMapType);
           map.controls[google.maps.ControlPosition.BOTTOM_RIGHT].push(copyrightControl);
           map.enableKeyDragZoom({
               visualEnabled: true,
               visualPosition: google.maps.ControlPosition.LEFT
           });
           directionsService = new google.maps.DirectionsService();
           markerIcon = new google.maps.MarkerImage(
                   "http://${mapserver}/mapfiles/kml/shapes/placemark_circle_maps.png",
                   new google.maps.Size(32, 32), null, new google.maps.Point(15, 16));
           addDebug("2. created map: " + map);

           google.maps.event.addListener(map, "maptypeid_changed", function() {
               if (map.getMapTypeId() == 'Mapnik' || map.getMapTypeId() == 'T@H' || map.getMapTypeId() == 'Cycle' || map.getMapTypeId() == 'Hike') {
                   copyrightControl.innerHTML = 'Map data &copy; <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> and contributors <a href="http://creativecommons.org/licenses/by-sa/2.0/" target="_blank">CC-BY-SA</a> -';
               } else if (map.getMapTypeId() == 'Outdoor' || map.getMapTypeId() == 'Topographic') {
                   copyrightControl.innerHTML = 'Map data &copy; <a href="http://www.outdooractive.com/" target="_blank">OutdoorActive</a> -';
               } else {
                   copyrightControl.innerHTML = '';
               }
               callJava("map-type-changed/" + map.getMapTypeId());
           });
           map.setMapTypeId('${maptype}');
           addDebug("2. set maptype: " + map.getMapTypeId());

           try {
               var menu = new ContextMenu({map:map});
               menu.addItem('Select', function(map, latLng) {
                   callJava("select-position/" + latLng.lat() + "/" + latLng.lng() + "/" + getThresholdForPixel(map, latLng, 15) + "/true");
               });
               menu.addItem('Insert', function(map, latLng) {
                   callJava("add-position/" + latLng.lat() + "/" + latLng.lng());
               });
               menu.addItem('Delete', function(map, latLng) {
                   callJava("remove-position/" + latLng.lat() + "/" + latLng.lng() + "/" + getThresholdForPixel(map, latLng, 15));
               });
               menu.addSep();
               menu.addItem('Center Here', function(map, latLng) {
                   map.panTo(latLng);
               });
               menu.addItem('Zoom In', function(map, latLng) {
                   map.setZoom(map.getZoom() + 1);
                   map.panTo(latLng);
               });
               menu.addItem('Zoom Out', function(map, latLng) {
                   map.setZoom(map.getZoom() - 1);
                   map.panTo(latLng);
               });
               addDebug("3. created menu: " + menu);
           } catch (e) {
               setError("<p>Sorry, could not initialize ContextMenu.</p><p>Error name: " + e.name + "</p><p>Error message: " + e.message + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
           }

           google.maps.event.addListener(map, "zoom_changed", function() {
               callJava("zoom-changed");
           });
           google.maps.event.addListener(map, "center_changed", function() {
               center = map.getCenter();
               callJava("center-changed/" + center.lat() + "/" + center.lng() + "/" + map.getZoom());
           });

           var shiftKey = false, altKey = false, ctrlKey = false;
           google.maps.event.addDomListener(document, "mousedown", function (event) {
             shiftKey = event.shiftKey; altKey = event.altKey; ctrlKey = event.ctrlKey;
           });
           google.maps.event.addListener(map, "click", function(event) {
               if (!shiftKey && !altKey && !ctrlKey) {
                   callJava("select-position/" + event.latLng.lat() + "/" + event.latLng.lng() + "/" + getThresholdForPixel(map, event.latLng, 15) + "/true");
               } else if (shiftKey && !altKey && !ctrlKey) {
                   callJava("select-position/" + event.latLng.lat() + "/" + event.latLng.lng() + "/" + getThresholdForPixel(map, event.latLng, 15) + "/false");
               } else if (!shiftKey && !altKey && ctrlKey) {
                   callJava("add-position/" + event.latLng.lat() + "/" + event.latLng.lng());
               } else if (!shiftKey && altKey && ctrlKey) {
                   callJava("remove-position/" + event.latLng.lat() + "/" + event.latLng.lng() + "/" + getThresholdForPixel(map, event.latLng, 15));
               }
           });
           addDebug("4. added listeners");

           try {
               if (window.XMLHttpRequest) {
                   xmlhttp = new XMLHttpRequest();
                   addDebug("5. created XMLHttpRequest");
                   initialized = true;
               } else if (window.ActiveXObject) {
                   xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
                   addDebug("6. created Microsoft XMLHttpRequest");
                   initialized = true;
               } else {
                   setError("<p>Sorry, could not find XMLHttpRequest or Microsoft.XMLHTTP.</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
               }
           }
           catch (e) {
               setError("<p>Sorry, could not initialize XMLHttpRequest.</p><p>Error name: " + e.name + "</p><p>Error message: " + e.message + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
           }

           try {
               if (window.addEventListener) {
                   addDebug("6. window.addEventListener");
                   window.addEventListener("keydown", function(event) {
                       ignoreCtrlF(event);
                   });
               } else if (document.addEventListener) {
                   addDebug("6. document.addEventListener");
                   document.addEventListener("keydown", function(event) {
                       ignoreCtrlF(event);
                   });
               } else if (window.attachEvent) {
                   addDebug("6. window.attachEvent");
                   window.attachEvent("keydown", function(event) {
                       ignoreCtrlF(event);
                   });
               }
           } catch (e) {
               setError("<p>Sorry, could not disable ctrl-f.</p><p>Error name: " + e.name + "</p><p>Error message: " + e.message + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
           }
       } catch (e) {
           setError("<p>Sorry, could not initialize Google Maps.</p><p>Error name: " + e.name + "</p><p>Error message: " + e.message + "</p><p><a href='javascript:self.location.reload()'>Retry</a></p>");
       }
   }
</script>
</body>
</html>
